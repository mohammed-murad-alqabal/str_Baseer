#!/bin/bash

# Pre-Commit Automation Hook
# ูุธุงู ุงูุฃุชูุชุฉ ุงูุฐููุฉ ูููุณุชูุฏุน
# ุงููุดุฑูุน: ุจุตูุฑ MVP

set -e

echo "๐ค [Automation] ุจุฏุก ุงููุญุต ุงูุชููุงุฆู..."

# ุงูุฃููุงู
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ุงููุชุบูุฑุงุช
ROOT_DIR=$(git rev-parse --show-toplevel)
MAX_ROOT_FILES=10
MAX_FILE_SIZE=$((10 * 1024 * 1024)) # 10 MB
AUTO_FIX=true
BACKUP_DIR="$ROOT_DIR/.git/automation-backups"

# ุฅูุดุงุก ูุฌูุฏ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
mkdir -p "$BACKUP_DIR"

# ====================
# 1. ูุญุต ุงููููุงุช ุงููุถุงูุฉ
# ====================
echo -e "${BLUE}[1/6]${NC} ูุญุต ุงููููุงุช ุงููุถุงูุฉ..."

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
ISSUES_FOUND=0
AUTO_FIXED=0

for file in $STAGED_FILES; do
    # ุชุฎุทู ุงููููุงุช ุงููุญุฐููุฉ
    [ ! -f "$file" ] && continue
    
    # ูุญุต ุญุฌู ุงูููู
    FILE_SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
    if [ "$FILE_SIZE" -gt "$MAX_FILE_SIZE" ]; then
        echo -e "${RED}โ${NC} ููู ูุจูุฑ ุฌุฏุงู: $file ($(numfmt --to=iec-i --suffix=B $FILE_SIZE))"
        echo "  ๐ก ุงุณุชุฎุฏู Git LFS ูููููุงุช ุงููุจูุฑุฉ"
        ISSUES_FOUND=$((ISSUES_FOUND + 1))
    fi
    
    # ูุญุต ุงููููุงุช ุงููุคูุชุฉ
    if [[ "$file" =~ ^test_.*\.(txt|json|log)$ ]] || [[ "$file" =~ test_archive ]]; then
        echo -e "${YELLOW}โ${NC} ููู ูุคูุช: $file"
        if [ "$AUTO_FIX" = true ]; then
            # ุฅุถุงูุฉ ุฅูู .gitignore
            echo "$file" >> .gitignore
            git reset HEAD "$file" 2>/dev/null || true
            echo -e "${GREEN}โ${NC} ุชู ุฅุฒุงูุฉ ุงูููู ูู staging ูุฅุถุงูุชู ุฅูู .gitignore"
            AUTO_FIXED=$((AUTO_FIXED + 1))
        fi
    fi
    
    # ูุญุต ูููุน ุงูุชูุงุฑูุฑ
    if [[ "$file" =~ ^[A-Z_]+_REPORT\.md$ ]] && [[ ! "$file" =~ ^Documentation/ ]]; then
        echo -e "${YELLOW}โ${NC} ุชูุฑูุฑ ูู ููุงู ุฎุงุทุฆ: $file"
        if [ "$AUTO_FIX" = true ]; then
            # ุชุญุฏูุฏ ุงููุฌูุฏ ุงูููุงุณุจ
            TARGET_DIR="Documentation/reports/fixes"
            if [[ "$file" =~ PERFORMANCE ]]; then
                TARGET_DIR="Documentation/reports/performance"
            elif [[ "$file" =~ TEST ]]; then
                TARGET_DIR="Documentation/reports/testing"
            elif [[ "$file" =~ BUILD ]]; then
                TARGET_DIR="Documentation/reports/builds"
            elif [[ "$file" =~ SESSION ]]; then
                TARGET_DIR="Documentation/sessions"
            fi
            
            # ููู ุงูููู
            mkdir -p "$TARGET_DIR"
            git mv "$file" "$TARGET_DIR/" 2>/dev/null || mv "$file" "$TARGET_DIR/"
            git add "$TARGET_DIR/$(basename $file)"
            echo -e "${GREEN}โ${NC} ุชู ููู ุงูุชูุฑูุฑ ุฅูู $TARGET_DIR/"
            AUTO_FIXED=$((AUTO_FIXED + 1))
        fi
    fi
done

# ====================
# 2. ูุญุต ุนุฏุฏ ุงููููุงุช ูู ุงูุฌุฐุฑ
# ====================
echo -e "${BLUE}[2/6]${NC} ูุญุต ุชูุธูู ุงูุฌุฐุฑ..."

ROOT_MD_COUNT=$(ls -1 *.md 2>/dev/null | wc -l | tr -d ' ')
if [ "$ROOT_MD_COUNT" -gt "$MAX_ROOT_FILES" ]; then
    echo -e "${YELLOW}โ${NC} ุนุฏุฏ ูููุงุช .md ูู ุงูุฌุฐุฑ: $ROOT_MD_COUNT (ุงูุญุฏ ุงูุฃูุตู: $MAX_ROOT_FILES)"
    ISSUES_FOUND=$((ISSUES_FOUND + 1))
fi

# ====================
# 3. ูุญุต ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ
# ====================
echo -e "${BLUE}[3/6]${NC} ูุญุต ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ..."

SENSITIVE_PATTERNS=(
    "password.*=.*['\"].*['\"]"
    "api[_-]?key.*=.*['\"].*['\"]"
    "secret.*=.*['\"].*['\"]"
    "token.*=.*['\"].*['\"]"
    "aws[_-]?access[_-]?key"
    "private[_-]?key"
)

for file in $STAGED_FILES; do
    [ ! -f "$file" ] && continue
    
    for pattern in "${SENSITIVE_PATTERNS[@]}"; do
        if grep -iE "$pattern" "$file" >/dev/null 2>&1; then
            echo -e "${RED}โ${NC} ุจูุงูุงุช ุญุณุงุณุฉ ูุญุชููุฉ ูู: $file"
            echo "  ๐ ูุฑุฌู ูุฑุงุฌุนุฉ ุงูููู ูุฅุฒุงูุฉ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ"
            ISSUES_FOUND=$((ISSUES_FOUND + 1))
            break
        fi
    done
done

# ====================
# 4. ูุญุต ุฌูุฏุฉ ุงูููุฏ (Flutter)
# ====================
echo -e "${BLUE}[4/6]${NC} ูุญุต ุฌูุฏุฉ ุงูููุฏ..."

DART_FILES=$(echo "$STAGED_FILES" | grep "\.dart$" || true)
if [ -n "$DART_FILES" ]; then
    if command -v flutter &> /dev/null; then
        if ! flutter analyze --no-pub 2>&1 | grep -q "No issues found"; then
            echo -e "${YELLOW}โ${NC} ุชูุฌุฏ ูุดุงูู ูู flutter analyze"
            echo "  ๐ก ูู ุจุชุดุบูู: flutter analyze"
        fi
    fi
fi

# ====================
# 5. ุชุญุฏูุซ CHANGELOG ุชููุงุฆูุงู
# ====================
echo -e "${BLUE}[5/6]${NC} ุงูุชุญูู ูู CHANGELOG..."

if [ -n "$STAGED_FILES" ]; then
    # ุงูุชุญูู ูู ูุฌูุฏ ุชุญุฏูุซ ูู CHANGELOG
    if ! echo "$STAGED_FILES" | grep -q "CHANGELOG.md"; then
        echo -e "${YELLOW}โน${NC} ูู ูุชู ุชุญุฏูุซ CHANGELOG.md"
        echo "  ๐ก ููุฑ ูู ุชูุซูู ุงูุชุบููุฑุงุช ูู CHANGELOG"
    fi
fi

# ====================
# 6. ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
# ====================
echo -e "${BLUE}[6/6]${NC} ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ..."

BACKUP_FILE="$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz"
if [ -n "$STAGED_FILES" ]; then
    tar -czf "$BACKUP_FILE" $STAGED_FILES 2>/dev/null || true
    echo -e "${GREEN}โ${NC} ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ: $(basename $BACKUP_FILE)"
fi

# ====================
# ุงููุชูุฌุฉ ุงูููุงุฆูุฉ
# ====================
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${GREEN}โ${NC} ุงููุญุต ุงูุชููุงุฆู ููุชูู"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ ุงูุฅุญุตุงุฆูุงุช:"
echo "  โข ุงููุดุงูู ุงูููุชุดูุฉ: $ISSUES_FOUND"
echo "  โข ุงูุฅุตูุงุญุงุช ุงูุชููุงุฆูุฉ: $AUTO_FIXED"
echo "  โข ุงููููุงุช ุงูููุญูุตุฉ: $(echo "$STAGED_FILES" | wc -l | tr -d ' ')"
echo ""

# ุงูุณูุงุญ ุจุงููุชุงุจุนุฉ ุญุชู ูุน ูุฌูุฏ ูุดุงูู (ุชุญุฐูุฑุงุช ููุท)
if [ "$ISSUES_FOUND" -gt 0 ]; then
    echo -e "${YELLOW}โ${NC} ุชูุฌุฏ $ISSUES_FOUND ูุดููุฉ ุชุญุชุงุฌ ูุฑุงุฌุนุฉ"
    echo "  ๐ก ููููู ุงููุชุงุจุนุฉุ ููู ูููุตุญ ุจูุฑุงุฌุนุฉ ุงููุดุงูู"
fi

exit 0
