name: PR Comment

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  comment:
    name: ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"
          channel: "stable"

      - name: Get dependencies
        run: flutter pub get

      - name: Run Analysis
        id: analyze
        run: |
          flutter analyze --no-pub > analysis.txt 2>&1 || true

          ERRORS=$(grep -c "error â€¢" analysis.txt || echo "0")
          WARNINGS=$(grep -c "warning â€¢" analysis.txt || echo "0")
          INFO=$(grep -c "info â€¢" analysis.txt || echo "0")

          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "info=$INFO" >> $GITHUB_OUTPUT

      - name: Run Tests
        id: tests
        run: |
          flutter test --coverage > tests.txt 2>&1 || true

          TOTAL=$(grep -oP '\d+(?= tests? passed)' tests.txt | head -1 || echo "0")
          PASSED=$(grep -oP '\d+(?= passed)' tests.txt | head -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failed)' tests.txt | head -1 || echo "0")

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          # Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
          if [ "$TOTAL" -gt 0 ]; then
            SUCCESS_RATE=$(awk "BEGIN {printf \"%.1f\", ($PASSED/$TOTAL)*100}")
          else
            SUCCESS_RATE="0.0"
          fi
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT

      - name: Calculate Coverage
        id: coverage
        run: |
          if [ -f "coverage/lcov.info" ]; then
            LINES_FOUND=$(grep -o "LF:[0-9]*" coverage/lcov.info | cut -d: -f2 | awk '{s+=$1} END {print s}')
            LINES_HIT=$(grep -o "LH:[0-9]*" coverage/lcov.info | cut -d: -f2 | awk '{s+=$1} END {print s}')
            
            if [ "$LINES_FOUND" -gt 0 ]; then
              COVERAGE=$(awk "BEGIN {printf \"%.1f\", ($LINES_HIT/$LINES_FOUND)*100}")
            else
              COVERAGE="0.0"
            fi
            
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "coverage=0.0" >> $GITHUB_OUTPUT
          fi

      - name: Determine Status
        id: status
        run: |
          ERRORS=${{ steps.analyze.outputs.errors }}
          FAILED=${{ steps.tests.outputs.failed }}
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          COVERAGE_INT=$(echo $COVERAGE | cut -d. -f1)

          if [ "$ERRORS" -gt 0 ] || [ "$FAILED" -gt 0 ]; then
            echo "status=âŒ ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          elif [ "$COVERAGE_INT" -lt 70 ]; then
            echo "status=âš ï¸ ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†" >> $GITHUB_OUTPUT
            echo "emoji=âš ï¸" >> $GITHUB_OUTPUT
          else
            echo "status=âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¯Ù…Ø¬" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const errors = '${{ steps.analyze.outputs.errors }}';
            const warnings = '${{ steps.analyze.outputs.warnings }}';
            const info = '${{ steps.analyze.outputs.info }}';
            const total = '${{ steps.tests.outputs.total }}';
            const passed = '${{ steps.tests.outputs.passed }}';
            const failed = '${{ steps.tests.outputs.failed }}';
            const successRate = '${{ steps.tests.outputs.success_rate }}';
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const status = '${{ steps.status.outputs.status }}';
            const emoji = '${{ steps.status.outputs.emoji }}';

            const coverageNum = parseFloat(coverage);
            let coverageEmoji = 'âŒ';
            if (coverageNum >= 70) coverageEmoji = 'âœ…';
            else if (coverageNum >= 50) coverageEmoji = 'âš ï¸';

            let testsEmoji = 'âœ…';
            if (failed > 0) testsEmoji = 'âŒ';
            else if (total == 0) testsEmoji = 'âš ï¸';

            const comment = `## ${emoji} ØªÙ‚Ø±ÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯

            **Ø§Ù„Ø­Ø§Ù„Ø©:** ${status}

            ### ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù„ÙŠÙ„

            | Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ | Ø§Ù„Ù‚ÙŠÙ…Ø© | Ø§Ù„Ø­Ø§Ù„Ø© |
            |:---|:---:|:---:|
            | Ø£Ø®Ø·Ø§Ø¡ | ${errors} | ${errors > 0 ? 'âŒ' : 'âœ…'} |
            | ØªØ­Ø°ÙŠØ±Ø§Øª | ${warnings} | ${warnings > 10 ? 'âš ï¸' : 'âœ…'} |
            | Ù…Ø¹Ù„ÙˆÙ…Ø§Øª | ${info} | â„¹ï¸ |

            ### ğŸ§ª Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ${testsEmoji}

            | Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ | Ø§Ù„Ù‚ÙŠÙ…Ø© |
            |:---|:---:|
            | Ø¥Ø¬Ù…Ø§Ù„ÙŠ | ${total} |
            | Ù†Ø¬Ø­ | ${passed} âœ… |
            | ÙØ´Ù„ | ${failed} ${failed > 0 ? 'âŒ' : ''} |
            | Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ | ${successRate}% |

            ### ğŸ“ˆ Ø§Ù„ØªØºØ·ÙŠØ© ${coverageEmoji}

            Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ©: ${coverage}%

            ${coverageNum >= 70 ? 'âœ… Ù…Ù…ØªØ§Ø²! Ø§Ù„ØªØºØ·ÙŠØ© Ø£Ø¹Ù„Ù‰ Ù…Ù† 70%' : ''}
            ${coverageNum >= 50 && coverageNum < 70 ? 'âš ï¸ Ø¬ÙŠØ¯ØŒ Ù„ÙƒÙ† ÙŠÙÙ†ØµØ­ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØºØ·ÙŠØ© Ø¥Ù„Ù‰ 70%+' : ''}
            ${coverageNum < 50 ? 'âŒ Ù…Ù†Ø®ÙØ¶! ÙŠØ¬Ø¨ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØºØ·ÙŠØ©' : ''}

            ### ğŸ“ Ø§Ù„ØªÙˆØµÙŠØ§Øª

            ${errors > 0 ? '- ğŸ”´ Ø­Ø±Ø¬: Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­Ø±Ø¬Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ù…Ø¬\n' : ''}
            ${failed > 0 ? '- âŒ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª: Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©\n' : ''}
            ${warnings > 10 ? '- âš ï¸ ØªØ­Ø°ÙŠØ±Ø§Øª: ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª\n' : ''}
            ${coverageNum < 70 ? '- ğŸ“Š ØªØºØ·ÙŠØ©: Ø²ÙŠØ§Ø¯Ø© Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ© Ø¥Ù„Ù‰ 70%+\n' : ''}
            ${errors == 0 && failed == 0 && coverageNum >= 70 ? '- âœ… Ù…Ù…ØªØ§Ø²: Ø§Ù„ÙƒÙˆØ¯ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¯Ù…Ø¬!\n' : ''}

            ---

            ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© GitHub Actions
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ØªÙ‚Ø±ÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
