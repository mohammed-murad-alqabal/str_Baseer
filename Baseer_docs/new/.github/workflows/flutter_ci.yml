name: Flutter CI/CD - Ø¨ØµÙŠØ± MVP

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.24.0"
  MIN_COVERAGE: 70

jobs:
  # Job 1: ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
  analyze-and-test:
    name: ğŸ” ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ø®ØªØ¨Ø§Ø±
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ¨ Verify formatting
        continue-on-error: true
        run: dart format --set-exit-if-changed lib/ test/ || true

      - name: ğŸ” Analyze code
        continue-on-error: true
        run: flutter analyze --fatal-infos || true

      - name: ğŸ§ª Run all tests
        continue-on-error: true
        run: flutter test --coverage --reporter expanded || true

      - name: ğŸ“Š Generate coverage report
        continue-on-error: true
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Test Coverage Report - Ø¨ØµÙŠØ± MVP"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ -f coverage/lcov.info ]; then
            # ØªØ«Ø¨ÙŠØª lcov
            sudo apt-get update -qq
            sudo apt-get install -y lcov
            
            # Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºØ·ÙŠØ©
            COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep lines | awk '{print $2}' | sed 's/%//' || echo "0")
            echo ""
            echo "ğŸ“ˆ Coverage: $COVERAGE%"
            echo "ğŸ¯ Target: ${{ env.MIN_COVERAGE }}%"
            echo ""
            
            # Ø­ÙØ¸ Ø§Ù„ØªØºØ·ÙŠØ© ÙÙŠ Ù…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø©
            echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºØ·ÙŠØ© (ØªØ­Ø°ÙŠØ± ÙÙ‚Ø·ØŒ Ù„Ø§ ÙØ´Ù„)
            if (( $(echo "$COVERAGE < ${{ env.MIN_COVERAGE }}" | bc -l) )); then
              echo "âš ï¸ Coverage is below target: $COVERAGE% < ${{ env.MIN_COVERAGE }}%"
              echo "ğŸ’¡ Please add more tests to reach the target coverage."
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            else
              echo "âœ… Coverage meets target: $COVERAGE% â‰¥ ${{ env.MIN_COVERAGE }}%"
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            fi
          else
            echo "âš ï¸ No coverage file found at coverage/lcov.info"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi

      - name: ğŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@e28ff129e5465c2c0dcc6f003fc735cb6ae0c673 # v4.5.0
        with:
          file: coverage/lcov.info
          fail_ci_if_error: false
          flags: unittests
          name: basser-coverage

      - name: ğŸ’¾ Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # Job 2: Ø¨Ù†Ø§Ø¡ Android
  build-android:
    name: ğŸ¤– Ø¨Ù†Ø§Ø¡ Android
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "21"
          cache: "gradle"

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ—ï¸ Build APK
        run: flutter build apk --release

      - name: ğŸ“ Check APK size
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ APK Size Report"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          SIZE_MB=$(du -m build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          SIZE_KB=$(du -k build/app/outputs/flutter-apk/app-release.apk | cut -f1)

          echo "ğŸ“Š APK Size: ${SIZE_MB}MB (${SIZE_KB}KB)"
          echo "ğŸ¯ Target: < 50 MB"
          echo ""

          if [ "$SIZE_MB" -gt 50 ]; then
            echo "âš ï¸  APK size exceeds target (> 50 MB)"
            echo "ğŸ’¡ Consider optimizing assets and dependencies"
          else
            echo "âœ… APK size is within target (< 50 MB)"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

  # Job 3: Ø¨Ù†Ø§Ø¡ iOS (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  build-ios:
    name: ğŸ Ø¨Ù†Ø§Ø¡ iOS
    runs-on: macos-latest
    needs: analyze-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ—ï¸ Build iOS (no codesign)
        run: flutter build ios --release --no-codesign

      - name: ğŸ“¤ Upload iOS build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/
          retention-days: 30

  # Job 4: ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
  security-scan:
    name: ğŸ”’ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run security scan
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”’ Security Scan Report"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # ÙØ­Øµ Ø§Ù„Ø£Ø³Ø±Ø§Ø± ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
          echo "ğŸ” Scanning for hardcoded secrets..."
          if grep -r -E "(password|secret|api_key|token)" lib/ --include="*.dart" | grep -v "// TODO\|// FIXME\|test\|SecureStorage"; then
            echo ""
            echo "âŒ Found potential secrets in code"
            echo "âš ï¸  Please remove hardcoded secrets and use secure storage"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi

          echo "âœ… No hardcoded secrets found"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: ğŸ“¦ Check dependencies for vulnerabilities
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Dependencies Security Check"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          flutter pub get
          flutter pub outdated --json > outdated.json || true

          echo "âœ… Dependencies checked"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Job 5: ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
  report:
    name: ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    runs-on: ubuntu-latest
    needs: [analyze-and-test, build-android, security-scan]
    if: always()

    steps:
      - name: ğŸ“‹ Generate final report
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š CI/CD Final Report - Ø¨ØµÙŠØ± MVP"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ” Analysis & Tests: ${{ needs.analyze-and-test.result }}"
          echo "ğŸ¤– Android Build: ${{ needs.build-android.result }}"
          echo "ğŸ”’ Security Scan: ${{ needs.security-scan.result }}"
          echo ""

          # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
          if [ "${{ needs.analyze-and-test.result }}" == "success" ] && \
             [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "âœ… Overall Status: SUCCESS"
            echo ""
            echo "ğŸ‰ All checks passed! Ready for deployment."
          else
            echo "âŒ Overall Status: FAILED"
            echo ""
            echo "âš ï¸  Some checks failed. Please review the logs above."
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“… Date: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”— Workflow: ${{ github.workflow }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
