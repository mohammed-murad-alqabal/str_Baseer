name: Release Management

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 1.0.0)"
        required: true
      release_type:
        description: "Release type"
        required: true
        type: choice
        options:
          - major
          - minor
          - patch

permissions:
  contents: write
  pull-requests: read

jobs:
  create-release:
    name: Ø¥Ù†Ø´Ø§Ø¡ Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"
          channel: "stable"
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "21"
          cache: "gradle"

      - name: Get dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Build APK
        run: flutter build apk --release

      - name: Build App Bundle
        run: flutter build appbundle --release

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù† CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            CHANGELOG=$(sed -n "/## \[${{ steps.version.outputs.version }}\]/,/## \[/p" CHANGELOG.md | sed '$d' || echo "No changelog entry found")
          else
            CHANGELOG="No CHANGELOG.md file found"
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Calculate APK size
        id: apk_size
        run: |
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          echo "size=$APK_SIZE" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            # ğŸ‰ Ø¥ØµØ¯Ø§Ø± ${{ steps.version.outputs.version }}

            ${{ steps.changelog.outputs.changelog }}

            ## ğŸ“¦ Ø§Ù„Ù…Ù„ÙØ§Øª

            - **APK:** `app-release.apk`
            - **App Bundle:** `app-release.aab`

            ## ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª

            - **Ø­Ø¬Ù… APK:** ${{ steps.apk_size.outputs.size }}
            - **Ø§Ù„ØªØ§Ø±ÙŠØ®:** $(date '+%Y-%m-%d %H:%M:%S')
            - **Commit:** ${{ github.sha }}

            ## ğŸ”— Ø§Ù„Ø±ÙˆØ§Ø¨Ø·

            - [CHANGELOG](CHANGELOG.md)
            - [Documentation](Documentation/)
            - [Issues](../../issues)
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify team
        if: success()
        run: |
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ steps.version.outputs.version }} Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ğŸ“¦ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ØªÙˆÙØ±Ø© ÙÙŠ Releases"
