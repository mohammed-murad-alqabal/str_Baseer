name: Analysis

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹
    - cron: "0 2 * * *"

jobs:
  analyze:
    name: ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"
          channel: "stable"

      - name: Get dependencies
        run: flutter pub get

      - name: Run Flutter Analyze
        id: analyze
        continue-on-error: true
        run: |
          flutter analyze --no-pub > analysis_output.txt 2>&1 || true
          cat analysis_output.txt

          # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª
          ERRORS=$(grep -c "error â€¢" analysis_output.txt || echo "0")
          WARNINGS=$(grep -c "warning â€¢" analysis_output.txt || echo "0")
          INFO=$(grep -c "info â€¢" analysis_output.txt || echo "0")

          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "info=$INFO" >> $GITHUB_OUTPUT

          # ØªØ­Ø°ÙŠØ± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡
          if [ "$ERRORS" -gt 0 ]; then
            echo "âš ï¸ ÙˆØ¬Ø¯Øª $ERRORS Ø£Ø®Ø·Ø§Ø¡ (non-blocking)"
          else
            echo "âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡"
          fi

      - name: Run Tests
        id: tests
        continue-on-error: true
        run: |
          flutter test --coverage > test_output.txt 2>&1 || true
          cat test_output.txt

          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
          TOTAL=$(grep -oP '\d+(?= tests? passed)' test_output.txt | head -1 || echo "0")
          PASSED=$(grep -oP '\d+(?= passed)' test_output.txt | head -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failed)' test_output.txt | head -1 || echo "0")

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          if [ "$FAILED" -gt 0 ]; then
            echo "âš ï¸ $FAILED Ø§Ø®ØªØ¨Ø§Ø± ÙØ´Ù„ (non-blocking)"
          else
            echo "âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª"
          fi

      - name: Calculate Coverage
        id: coverage
        continue-on-error: true
        run: |
          if [ -f "coverage/lcov.info" ]; then
            # Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºØ·ÙŠØ©
            LINES_FOUND=$(grep -o "LF:[0-9]*" coverage/lcov.info | cut -d: -f2 | awk '{s+=$1} END {print s}' || echo "0")
            LINES_HIT=$(grep -o "LH:[0-9]*" coverage/lcov.info | cut -d: -f2 | awk '{s+=$1} END {print s}' || echo "0")
            
            if [ "$LINES_FOUND" -gt 0 ]; then
              COVERAGE=$(awk "BEGIN {printf \"%.1f\", ($LINES_HIT/$LINES_FOUND)*100}")
            else
              COVERAGE="0.0"
            fi
            
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ©: $COVERAGE%"
            
            # ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØªØºØ·ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø© (non-blocking)
            COVERAGE_INT=$(echo $COVERAGE | cut -d. -f1)
            if [ "$COVERAGE_INT" -lt 70 ]; then
              echo "âš ï¸ Ø§Ù„ØªØºØ·ÙŠØ© Ø£Ù‚Ù„ Ù…Ù† 70% (non-blocking)"
            else
              echo "âœ… Ø§Ù„ØªØºØ·ÙŠØ© ØªÙÙˆÙ‚ 70%"
            fi
          else
            echo "coverage=0.0" >> $GITHUB_OUTPUT
            echo "âš ï¸ Ù…Ù„Ù Ø§Ù„ØªØºØ·ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          fi

      - name: Generate Report
        if: always()
        continue-on-error: true
        run: |
          if [ -f "scripts/generate_report.sh" ]; then
            bash scripts/generate_report.sh --output analysis_report.md || true
          else
            echo "âš ï¸ generate_report.sh not found - creating basic report"
            echo "# Analysis Report" > analysis_report.md
            echo "" >> analysis_report.md
            echo "## Summary" >> analysis_report.md
            echo "- Errors: ${{ steps.analyze.outputs.errors }}" >> analysis_report.md
            echo "- Warnings: ${{ steps.analyze.outputs.warnings }}" >> analysis_report.md
            echo "- Tests Passed: ${{ steps.tests.outputs.passed }}" >> analysis_report.md
            echo "- Coverage: ${{ steps.coverage.outputs.coverage }}%" >> analysis_report.md
          fi

      - name: Upload Analysis Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report
          path: analysis_report.md
          retention-days: 30

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù„ÙŠÙ„" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Flutter Analyze" >> $GITHUB_STEP_SUMMARY
          echo "- Ø£Ø®Ø·Ø§Ø¡: ${{ steps.analyze.outputs.errors }}" >> $GITHUB_STEP_SUMMARY
          echo "- ØªØ­Ø°ÙŠØ±Ø§Øª: ${{ steps.analyze.outputs.warnings }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª: ${{ steps.analyze.outputs.info }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª" >> $GITHUB_STEP_SUMMARY
          echo "- Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${{ steps.tests.outputs.total }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ù†Ø¬Ø­: ${{ steps.tests.outputs.passed }} âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- ÙØ´Ù„: ${{ steps.tests.outputs.failed }} âŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Ø§Ù„ØªØºØ·ÙŠØ©" >> $GITHUB_STEP_SUMMARY
          echo "- Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ©: ${{ steps.coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
