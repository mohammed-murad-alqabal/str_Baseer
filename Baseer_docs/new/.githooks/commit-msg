#!/bin/bash

# Git Hook: commit-msg
# يتحقق من أن رسالة الـ commit تتبع معيار Conventional Commits

set -e

# الألوان
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# قراءة رسالة الـ commit
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# الأنواع المسموحة
VALID_TYPES="feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert"

# التحقق من الصيغة
if ! echo "$COMMIT_MSG" | grep -qE "^($VALID_TYPES)(\(.+\))?: .+"; then
    echo -e "${RED}❌ رسالة commit غير صحيحة!${NC}"
    echo ""
    echo -e "${YELLOW}الصيغة الصحيحة:${NC}"
    echo "  type(scope): description"
    echo ""
    echo -e "${YELLOW}الأنواع المسموحة:${NC}"
    echo "  ${GREEN}feat${NC}:     ميزة جديدة"
    echo "  ${GREEN}fix${NC}:      إصلاح خطأ"
    echo "  ${GREEN}docs${NC}:     توثيق"
    echo "  ${GREEN}style${NC}:    تنسيق (لا يؤثر على المعنى)"
    echo "  ${GREEN}refactor${NC}: إعادة هيكلة"
    echo "  ${GREEN}perf${NC}:     تحسين أداء"
    echo "  ${GREEN}test${NC}:     اختبارات"
    echo "  ${GREEN}chore${NC}:    مهام صيانة"
    echo "  ${GREEN}build${NC}:    نظام البناء"
    echo "  ${GREEN}ci${NC}:       CI/CD"
    echo "  ${GREEN}revert${NC}:   تراجع عن commit"
    echo ""
    echo -e "${YELLOW}أمثلة:${NC}"
    echo "  feat(auth): إضافة تسجيل دخول بالبصمة"
    echo "  fix(invoice): إصلاح حساب الضريبة"
    echo "  docs: تحديث README"
    echo "  feat!: تغيير واجهة API (breaking change)"
    echo ""
    echo -e "${YELLOW}رسالتك:${NC}"
    echo "  $COMMIT_MSG"
    echo ""
    exit 1
fi

# التحقق من طول السطر الأول
FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)
if [ ${#FIRST_LINE} -gt 72 ]; then
    echo -e "${YELLOW}⚠️  تحذير: السطر الأول طويل جداً (${#FIRST_LINE} حرف)${NC}"
    echo "  يُفضل أن يكون أقل من 72 حرف"
    echo ""
fi

# التحقق من وجود سطر فارغ بعد السطر الأول (إذا كان هناك نص إضافي)
LINE_COUNT=$(echo "$COMMIT_MSG" | wc -l)
if [ $LINE_COUNT -gt 1 ]; then
    SECOND_LINE=$(echo "$COMMIT_MSG" | sed -n '2p')
    if [ ! -z "$SECOND_LINE" ]; then
        echo -e "${YELLOW}⚠️  تحذير: يجب ترك سطر فارغ بعد السطر الأول${NC}"
        echo ""
    fi
fi

echo -e "${GREEN}✅ رسالة commit صحيحة!${NC}"
exit 0
