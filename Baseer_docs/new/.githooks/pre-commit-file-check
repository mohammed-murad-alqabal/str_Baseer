#!/bin/bash
# Pre-commit hook: File Organization Check
# Prevents adding unwanted files to project root
# Part of Basser MVP file organization standards

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ù„ÙØ§Øª...${NC}"

# Check for unwanted files in root
UNWANTED_PATTERNS=(
  '^\w+\.log$'
  '^\w+\.tmp$'
  '^\w+\.temp$'
  '^\w+\.bak$'
  '^\w+\.db$'
  '^\w+\.so$'
  '^\w+\.dll$'
  '^\w+\.dylib$'
  '^[A-Z_]+_REPORT\.md$'
  '^[A-Z_]+_STATUS\.md$'
  '^[A-Z_]+_SUMMARY\.md$'
  '^[A-Z_]+_GUIDE\.md$'
  '^[A-Z_]+_ANALYSIS\.md$'
  '^CHECKPOINT_.*\.md$'
  '^CONTINUATION_.*\.md$'
  '^IMMEDIATE_.*\.md$'
)

# Get staged files in root
STAGED_ROOT_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E '^[^/]+\.(log|tmp|temp|bak|db|so|dll|dylib|md)$')

if [ -z "$STAGED_ROOT_FILES" ]; then
  echo -e "${GREEN}âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ØºÙŠØ± Ù…Ø±ØºÙˆØ¨Ø©${NC}"
  exit 0
fi

# Check each file
VIOLATIONS=()
while IFS= read -r file; do
  if [ -z "$file" ]; then
    continue
  fi
  
  # Check against patterns
  for pattern in "${UNWANTED_PATTERNS[@]}"; do
    if echo "$file" | grep -qE "$pattern"; then
      VIOLATIONS+=("$file")
      break
    fi
  done
done <<< "$STAGED_ROOT_FILES"

# If violations found, show error and exit
if [ ${#VIOLATIONS[@]} -gt 0 ]; then
  echo -e "${RED}âŒ Ø®Ø·Ø£: Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª ØºÙŠØ± Ù…Ø±ØºÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ø¬Ø°Ø±!${NC}"
  echo ""
  echo -e "${YELLOW}Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©:${NC}"
  for file in "${VIOLATIONS[@]}"; do
    echo -e "  ${RED}âœ—${NC} $file"
  done
  echo ""
  echo -e "${YELLOW}Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©:${NC}"
  echo ""
  echo -e "  ${GREEN}*.log${NC}     â†’ logs/"
  echo -e "  ${GREEN}*.tmp${NC}     â†’ /tmp/"
  echo -e "  ${GREEN}*.bak${NC}     â†’ backups/"
  echo -e "  ${GREEN}*.db${NC}      â†’ .kiro/data/"
  echo -e "  ${GREEN}*.so/dll${NC}  â†’ (Ù…ÙÙˆÙ„Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ Ø£Ø¶ÙÙ‡Ø§ Ù„Ù€ .gitignore)"
  echo -e "  ${GREEN}*_REPORT.md${NC} â†’ Documentation/reports/ Ø£Ùˆ .kiro/docs/reports/"
  echo ""
  echo -e "${YELLOW}Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª:${NC}"
  echo -e "  cat .kiro/standards/file-organization.md"
  echo ""
  exit 1
fi

echo -e "${GREEN}âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø£Ù…Ø§ÙƒÙ†Ù‡Ø§ Ø§Ù„ØµØ­ÙŠØ­Ø©${NC}"
exit 0
