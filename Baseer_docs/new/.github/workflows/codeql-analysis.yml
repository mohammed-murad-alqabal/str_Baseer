name: CodeQL Security Analysis

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run at 2 AM UTC every day
    - cron: "0 2 * * *"

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  analyze:
    name: ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ŸÖÿßŸÜ
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        language: ["javascript"]
        # CodeQL supports: cpp, csharp, go, java, javascript, python, ruby
        # For Dart/Flutter, we use JavaScript analysis for any JS/TS code

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@afb54ba388a7dca6ecae48f608c4ff05ff4cc77a # v3.25.15
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@afb54ba388a7dca6ecae48f608c4ff05ff4cc77a # v3.25.15

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@afb54ba388a7dca6ecae48f608c4ff05ff4cc77a # v3.25.15
        with:
          category: "/language:${{ matrix.language }}"

  dart-security-scan:
    name: ŸÅÿ≠ÿµ ÿ£ŸÖÿßŸÜ Dart
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"
          channel: "stable"

      - name: Install dependencies
        run: flutter pub get

      - name: Run security audit
        run: |
          echo "üîí Running security audit..."

          # Check for known vulnerabilities
          flutter pub outdated --mode=null-safety

          # Run static analysis with security focus
          flutter analyze --no-pub

          echo "‚úÖ Security audit completed"

      - name: Check for hardcoded secrets
        continue-on-error: true
        run: |
          echo "üîç Scanning for hardcoded secrets..."

          # Patterns to search for
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]{8,}['\"]"
            "api[_-]?key\s*=\s*['\"][^'\"]{20,}['\"]"
            "secret\s*=\s*['\"][^'\"]{20,}['\"]"
            "token\s*=\s*['\"][^'\"]{20,}['\"]"
            "private[_-]?key"
            "-----BEGIN.*PRIVATE KEY-----"
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -r -E "$pattern" lib/ --include="*.dart" 2>/dev/null | grep -v "// TODO\|// FIXME\|test\|SecureStorage\|flutter_secure_storage"; then
              echo "‚ö†Ô∏è Potential secret found: $pattern"
              FOUND=$((FOUND + 1))
            fi
          done

          if [ $FOUND -gt 0 ]; then
            echo "‚ö†Ô∏è Found $FOUND potential secrets (non-blocking)"
            echo "Please review and remove any hardcoded secrets"
          else
            echo "‚úÖ No hardcoded secrets detected"
          fi

      - name: Check file permissions
        run: |
          echo "üîê Checking file permissions..."

          # Check for files with overly permissive permissions
          find . -type f -perm /o+w -not -path "./.git/*" -not -path "./build/*"

          echo "‚úÖ Permission check completed"

      - name: Scan for SQL injection vulnerabilities
        continue-on-error: true
        run: |
          echo "üíâ Scanning for SQL injection vulnerabilities..."

          # Check for potential SQL injection patterns
          if grep -r "SELECT.*\$\|INSERT.*\$\|UPDATE.*\$\|DELETE.*\$" lib/ --include="*.dart" 2>/dev/null; then
            echo "‚ö†Ô∏è Potential SQL injection vulnerability found"
            echo "Please use parameterized queries"
          else
            echo "‚úÖ No SQL injection vulnerabilities detected"
          fi

      - name: Check for insecure random number generation
        continue-on-error: true
        run: |
          echo "üé≤ Checking random number generation..."

          # Check for use of insecure random
          if grep -r "Random()" lib/ --include="*.dart" 2>/dev/null | grep -v "import.*Random"; then
            echo "‚ö†Ô∏è Insecure random number generation detected"
            echo "Consider using crypto.Random.secure()"
          else
            echo "‚úÖ Random number generation is secure"
          fi
