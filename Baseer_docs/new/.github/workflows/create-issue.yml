name: Create Issue

on:
  workflow_run:
    workflows: ["Analysis"]
    types:
      - completed

permissions:
  issues: write
  contents: read

jobs:
  create-issue:
    name: Ø¥Ù†Ø´Ø§Ø¡ Issue Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­Ø±Ø¬Ø©
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Analysis Report
        uses: actions/download-artifact@v4
        with:
          name: analysis-report
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true
      
      - name: Parse Analysis Results
        id: parse
        run: |
          if [ -f "analysis_report.md" ]; then
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            ERRORS=$(grep -oP 'Ø£Ø®Ø·Ø§Ø¡.*\|\s*\K\d+' analysis_report.md | head -1 || echo "0")
            WARNINGS=$(grep -oP 'ØªØ­Ø°ÙŠØ±Ø§Øª.*\|\s*\K\d+' analysis_report.md | head -1 || echo "0")
            
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
            
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ù‡Ù… Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            sed -n '/Ø£Ù‡Ù… Ø§Ù„Ø£Ø®Ø·Ø§Ø¡/,/Ø£Ù‡Ù… Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª/p' analysis_report.md | head -20 > errors.txt || true
          else
            echo "errors=0" >> $GITHUB_OUTPUT
            echo "warnings=0" >> $GITHUB_OUTPUT
            echo "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„" > errors.txt
          fi
      
      - name: Create Issue for Critical Errors
        if: steps.parse.outputs.errors > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errors = '${{ steps.parse.outputs.errors }}';
            const warnings = '${{ steps.parse.outputs.warnings }}';
            
            let errorDetails = '';
            try {
              errorDetails = fs.readFileSync('errors.txt', 'utf8');
            } catch (e) {
              errorDetails = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡';
            }
            
            const issueBody = `## ğŸ”´ Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø© ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„
            
**Ø§Ù„ØªØ§Ø±ÙŠØ®:** ${new Date().toLocaleString('ar-SA')}  
**Workflow Run:** [#${{ github.event.workflow_run.id }}](${{ github.event.workflow_run.html_url }})  
**Branch:** ${{ github.event.workflow_run.head_branch }}  
**Commit:** ${{ github.event.workflow_run.head_sha }}

### ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ

- **Ø£Ø®Ø·Ø§Ø¡:** ${errors}
- **ØªØ­Ø°ÙŠØ±Ø§Øª:** ${warnings}

### ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡

\`\`\`
${errorDetails}
\`\`\`

### ğŸ“ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

- [ ] Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ø£Ø¹Ù„Ø§Ù‡
- [ ] Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­Ø±Ø¬Ø©
- [ ] ØªØ´ØºÙŠÙ„ \`flutter analyze\` Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„ØªØ­Ù‚Ù‚
- [ ] Ø¥Ù†Ø´Ø§Ø¡ PR Ù…Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª

### ğŸ”— Ø§Ù„Ù…ÙˆØ§Ø±Ø¯

- [ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})
- [Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¬ÙˆØ¯Ø©](.kiro/steering/code-quality-standards.md)

---

**ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø©:** GitHub Actions  
**Label:** \`automated\`, \`bug\`, \`critical\`
`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”´ Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø©: ${errors} Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„`,
              body: issueBody,
              labels: ['automated', 'bug', 'critical', 'code-quality']
            });
      
      - name: Create Issue for High Warnings
        if: steps.parse.outputs.warnings > 20
        uses: actions/github-script@v7
        with:
          script: |
            const warnings = '${{ steps.parse.outputs.warnings }}';
            
            const issueBody = `## âš ï¸ Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª
            
**Ø§Ù„ØªØ§Ø±ÙŠØ®:** ${new Date().toLocaleString('ar-SA')}  
**Workflow Run:** [#${{ github.event.workflow_run.id }}](${{ github.event.workflow_run.html_url }})

### ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ

- **Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª:** ${warnings}
- **Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„:** 20

### ğŸ“ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

- [ ] Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª
- [ ] ØªØ­Ø¯ÙŠØ¯ Ø£ÙˆÙ„ÙˆÙŠØ§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­
- [ ] Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª

### ğŸ¯ Ø§Ù„Ù‡Ø¯Ù

ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª Ø¥Ù„Ù‰ Ø£Ù‚Ù„ Ù…Ù† 10.

---

**ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø©:** GitHub Actions  
**Label:** \`automated\`, \`enhancement\`, \`code-quality\`
`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª: ${warnings}`,
              body: issueBody,
              labels: ['automated', 'enhancement', 'code-quality']
            });
