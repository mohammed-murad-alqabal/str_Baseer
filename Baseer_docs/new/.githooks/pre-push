#!/bin/bash

# Enhanced Pre-Push Hook v2.0
# Implements: COLLABORATION FIRST, KISS, Security First, Quality First, ENGLISH FOR CODE
# Project: Basser MVP
# Author: Basser Development Agents Team
# Date: December 8, 2025

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print colored message
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# Print section header
print_header() {
    echo ""
    print_message "$BLUE" "=================================================="
    print_message "$BLUE" "$1"
    print_message "$BLUE" "=================================================="
    echo ""
}

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Main execution
main() {
    print_header "ğŸš€ Pre-Push Hook v2.0"
    
    print_message "$BLUE" "Running pre-push checks..."
    echo ""
    
    # 1. Check for Flutter
    if ! command_exists flutter; then
        print_message "$RED" "âŒ Flutter not found"
        exit 1
    fi
    
    # 2. Run all tests
    print_header "ğŸ§ª Running Tests"
    print_message "$BLUE" "Running all tests..."
    
    if ! flutter test; then
        print_message "$RED" "âŒ Tests failed"
        print_message "$YELLOW" "ğŸ’¡ Fix failing tests before pushing"
        exit 1
    fi
    print_message "$GREEN" "âœ… All tests passed"
    
    # 3. Check test coverage (Quality First: 70%+)
    print_header "ğŸ“Š Test Coverage"
    print_message "$BLUE" "Checking test coverage..."
    
    if ! flutter test --coverage >/dev/null 2>&1; then
        print_message "$YELLOW" "âš ï¸  Could not generate coverage report"
    else
        if command_exists lcov; then
            # Calculate coverage percentage
            coverage_file="coverage/lcov.info"
            if [ -f "$coverage_file" ]; then
                total_lines=$(lcov --summary "$coverage_file" 2>&1 | grep "lines" | awk '{print $2}' | cut -d'%' -f1)
                
                if [ -n "$total_lines" ]; then
                    print_message "$BLUE" "ğŸ“Š Coverage: ${total_lines}%"
                    
                    if (( $(echo "$total_lines < 70" | bc -l) )); then
                        print_message "$YELLOW" "âš ï¸  Coverage (${total_lines}%) is below 70%"
                        print_message "$YELLOW" "ğŸ’¡ Consider adding more tests"
                    else
                        print_message "$GREEN" "âœ… Coverage is above 70%"
                    fi
                fi
            fi
        else
            print_message "$YELLOW" "âš ï¸  lcov not found. Install with: apt-get install lcov (Linux) or brew install lcov (macOS)"
        fi
    fi
    
    # 4. Static analysis
    print_header "ğŸ” Static Analysis"
    print_message "$BLUE" "Running flutter analyze..."
    
    if ! flutter analyze --no-fatal-infos; then
        print_message "$RED" "âŒ Static analysis failed"
        print_message "$YELLOW" "ğŸ’¡ Fix the issues above before pushing"
        exit 1
    fi
    print_message "$GREEN" "âœ… Static analysis passed"
    
    # 5. Check for TODOs in critical files
    print_header "ğŸ“ TODO Check"
    print_message "$BLUE" "Checking for critical TODOs..."
    
    critical_todos=$(git diff origin/main...HEAD --name-only | \
        grep -E '\.(dart)$' | \
        xargs grep -n "TODO.*CRITICAL\|FIXME.*CRITICAL" 2>/dev/null || true)
    
    if [ -n "$critical_todos" ]; then
        print_message "$YELLOW" "âš ï¸  Critical TODOs found:"
        echo "$critical_todos"
        print_message "$YELLOW" "ğŸ’¡ Consider resolving critical TODOs before pushing"
    else
        print_message "$GREEN" "âœ… No critical TODOs found"
    fi
    
    # 6. Check for debug code
    print_header "ğŸ› Debug Code Check"
    print_message "$BLUE" "Checking for debug code..."
    
    debug_code=$(git diff origin/main...HEAD --name-only | \
        grep -E '\.(dart)$' | \
        xargs grep -n "print(\|debugPrint(\|console.log(" 2>/dev/null || true)
    
    if [ -n "$debug_code" ]; then
        print_message "$YELLOW" "âš ï¸  Debug print statements found:"
        echo "$debug_code" | head -5
        print_message "$YELLOW" "ğŸ’¡ Consider removing debug prints before pushing"
    else
        print_message "$GREEN" "âœ… No debug code found"
    fi
    
    # 7. Check branch protection
    print_header "ğŸ”’ Branch Protection"
    print_message "$BLUE" "Checking branch..."
    
    current_branch=$(git rev-parse --abbrev-ref HEAD)
    
    if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
        print_message "$YELLOW" "âš ï¸  Pushing directly to $current_branch"
        print_message "$YELLOW" "ğŸ’¡ Consider using feature branches and pull requests"
    else
        print_message "$GREEN" "âœ… Pushing to feature branch: $current_branch"
    fi
    
    # 8. Security check for sensitive files
    print_header "ğŸ”’ Security Check"
    print_message "$BLUE" "Checking for sensitive files..."
    
    sensitive_files=$(git diff origin/main...HEAD --name-only | \
        grep -E '\.(key|pem|p12|jks|keystore|env)$' || true)
    
    if [ -n "$sensitive_files" ]; then
        print_message "$RED" "âŒ Sensitive files detected:"
        echo "$sensitive_files"
        print_message "$RED" "ğŸ’¡ Do not commit sensitive files!"
        exit 1
    fi
    print_message "$GREEN" "âœ… No sensitive files found"
    
    # Success
    print_header "âœ… Pre-Push Checks Passed!"
    
    print_message "$GREEN" "ğŸ‰ All checks passed!"
    print_message "$BLUE" "ğŸš€ Proceeding with push..."
    
    echo ""
    print_message "$BLUE" "Principles Applied:"
    print_message "$GREEN" "- âœ… COLLABORATION FIRST: Clear feedback on issues"
    print_message "$GREEN" "- âœ… KISS: Simple, focused checks"
    print_message "$GREEN" "- âœ… Security First: Sensitive file detection"
    print_message "$GREEN" "- âœ… Quality First: Tests and coverage checks"
    print_message "$GREEN" "- âœ… ENGLISH FOR CODE: All checks in English"
}

# Run main function
main "$@"
