name: Error Tracking & Reporting

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  analyze-and-report:
    name: ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"
          channel: "stable"
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run Flutter Analyze
        id: analyze
        continue-on-error: true
        run: |
          flutter analyze > analyze_output.txt 2>&1 || true
          echo "analyze_exit_code=$?" >> $GITHUB_OUTPUT

          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          ISSUES_COUNT=$(grep -c "issue" analyze_output.txt || echo "0")
          ERRORS_COUNT=$(grep -c "error â€¢" analyze_output.txt || echo "0")
          WARNINGS_COUNT=$(grep -c "warning â€¢" analyze_output.txt || echo "0")
          INFO_COUNT=$(grep -c "info â€¢" analyze_output.txt || echo "0")

          echo "issues_count=$ISSUES_COUNT" >> $GITHUB_OUTPUT
          echo "errors_count=$ERRORS_COUNT" >> $GITHUB_OUTPUT
          echo "warnings_count=$WARNINGS_COUNT" >> $GITHUB_OUTPUT
          echo "info_count=$INFO_COUNT" >> $GITHUB_OUTPUT

      - name: Run Tests
        id: test
        continue-on-error: true
        run: |
          flutter test > test_output.txt 2>&1 || true
          echo "test_exit_code=$?" >> $GITHUB_OUTPUT

          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
          PASSED=$(grep -oP '\+\K[0-9]+' test_output.txt | tail -1 || echo "0")
          FAILED=$(grep -oP '\-\K[0-9]+' test_output.txt | tail -1 || echo "0")
          SKIPPED=$(grep -oP '~\K[0-9]+' test_output.txt | tail -1 || echo "0")

          echo "tests_passed=$PASSED" >> $GITHUB_OUTPUT
          echo "tests_failed=$FAILED" >> $GITHUB_OUTPUT
          echo "tests_skipped=$SKIPPED" >> $GITHUB_OUTPUT

      - name: Create Error Report
        run: |
          mkdir -p logs/reports

          cat > logs/reports/error_report_$(date +%Y-%m-%d).md << 'EOF'
          # ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ

          **Ø§Ù„ØªØ§Ø±ÙŠØ®:** $(date '+%Y-%m-%d %H:%M:%S')  
          **Commit:** ${{ github.sha }}  
          **Branch:** ${{ github.ref_name }}

          ## ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Flutter Analyze

          | Ø§Ù„Ù†ÙˆØ¹ | Ø§Ù„Ø¹Ø¯Ø¯ |
          |:---|:---:|
          | **Errors** | ${{ steps.analyze.outputs.errors_count }} |
          | **Warnings** | ${{ steps.analyze.outputs.warnings_count }} |
          | **Info** | ${{ steps.analyze.outputs.info_count }} |
          | **Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ** | ${{ steps.analyze.outputs.issues_count }} |

          ## ğŸ§ª Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª

          | Ø§Ù„Ø­Ø§Ù„Ø© | Ø§Ù„Ø¹Ø¯Ø¯ |
          |:---|:---:|
          | **Ù†Ø¬Ø­** âœ… | ${{ steps.test.outputs.tests_passed }} |
          | **ÙØ´Ù„** âŒ | ${{ steps.test.outputs.tests_failed }} |
          | **ØªØ®Ø·ÙŠ** â­ï¸ | ${{ steps.test.outputs.tests_skipped }} |

          ## ğŸ“ Ø§Ù„ØªÙØ§ØµÙŠÙ„

          ### Flutter Analyze Output
          ```
          $(cat analyze_output.txt | head -50)
          ```

          ### Test Output
          ```
          $(cat test_output.txt | tail -30)
          ```
          EOF

      - name: Upload Error Report
        uses: actions/upload-artifact@v4
        with:
          name: error-report-${{ github.run_number }}
          path: logs/reports/
          retention-days: 30

      - name: Create Issue on Critical Errors
        if: steps.analyze.outputs.errors_count > 0
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const errorsCount = ${{ steps.analyze.outputs.errors_count }};
            const warningsCount = ${{ steps.analyze.outputs.warnings_count }};
            const testsFailedCount = ${{ steps.test.outputs.tests_failed }};

            if (errorsCount > 0 || testsFailedCount > 0) {
              const title = `ğŸš¨ Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø© Ù…ÙƒØªØ´ÙØ© - ${new Date().toISOString().split('T')[0]}`;
              const body = `
              # ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
              
              ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.
              
              ## ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
              
              - **Errors:** ${errorsCount}
              - **Warnings:** ${warningsCount}
              - **Tests Failed:** ${testsFailedCount}
              
              ## ğŸ”— Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
              
              - **Commit:** ${context.sha}
              - **Branch:** ${context.ref}
              - **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              ## ğŸ“ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
              
              - [ ] Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
              - [ ] Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø±Ø¬Ø©
              - [ ] ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
              - [ ] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª
              
              ---
              *ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© GitHub Actions*
              `;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'automated', 'critical']
              });
            }

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const errorsCount = ${{ steps.analyze.outputs.errors_count }};
            const warningsCount = ${{ steps.analyze.outputs.warnings_count }};
            const testsPassedCount = ${{ steps.test.outputs.tests_passed }};
            const testsFailedCount = ${{ steps.test.outputs.tests_failed }};

            const comment = `
            ## ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯

            ### Flutter Analyze
            - âŒ Errors: ${errorsCount}
            - âš ï¸ Warnings: ${warningsCount}
            - â„¹ï¸ Info: ${{ steps.analyze.outputs.info_count }}

            ### Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
            - âœ… Ù†Ø¬Ø­: ${testsPassedCount}
            - âŒ ÙØ´Ù„: ${testsFailedCount}
            - â­ï¸ ØªØ®Ø·ÙŠ: ${{ steps.test.outputs.tests_skipped }}

            ${errorsCount > 0 ? 'âš ï¸ **ØªØ­Ø°ÙŠØ±:** ÙŠÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø© ÙŠØ¬Ø¨ Ø¥ØµÙ„Ø§Ø­Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ù…Ø¬!' : ''}
            ${testsFailedCount > 0 ? 'âš ï¸ **ØªØ­Ø°ÙŠØ±:** ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ§Ø´Ù„Ø©!' : ''}
            ${errorsCount === 0 && testsFailedCount === 0 ? 'âœ… **Ù…Ù…ØªØ§Ø²!** Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø©.' : ''}
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
